function t(t){return null!=n(t).main_time?n(t).main_time:null}function e(t){return"byoyomi"===n(t).system?n(t).period_time:null}function n(t){return t.gamedata.time_control}function r(t){const e=t/1e3,n=t>=1e3?Math.round(e):e;return n<60?function(t){const e=t.toFixed(1);return(e.endsWith(".0")?e.slice(0,-2):e)+"s"}(n):function(t){const e=Math.trunc(t%60);return[Math.trunc(t/60)+"m",0!==e?e+"s":""].filter((t=>t)).join(" ")}(n)}function o(t,e,n){t.remove();const r="before"===e?"beforebegin":"afterend";n.insertAdjacentElement(r,t)}function a(t){switch(t.length){case 0:return 0;case 1:return t[0];case 2:return 0===(e=t).length?0:e.reduce(((t,e)=>t+e),0)/e.length;default:return a(t.slice(1,-1))}var e}function i(t,e){return t-e}function l(t,e){const n=t.filter((t=>t.color===e)),o=n.filter((t=>"main"===t.clockPhase)),l=n.filter((t=>"overtime"===t.clockPhase)),c=o.length>0?r(a(o.map((t=>t.millis)).sort(i))):"-",s=l.length>0?r(a(l.map((t=>t.millis)).sort(i))):"-";return`<tr>\n  <th>${e}</th>\n  <td>${c}</td>\n  <td>${s}</td>\n</tr>`}const c="ogsMoveTimingCleanUp";try{"function"==typeof window[c]&&window[c]();const n=function(t){const e=/https:\/\/online-go\.com\/game\/(view\/)?(\d+)/.exec(t),n=e?e[2]:null;if(!n)throw new Error("The move timing chart can only be loaded from OGS games.\n\nIf you're in a review, load the chart in game view first then return to the review.");return n}(window.location.toString()),{playerCards:a,actionBar:i,moveNumberContainer:s}=function(){const t=document.querySelector("div:has(> .players)"),e=document.querySelector(".action-bar"),n=document.querySelector(".move-number");if(!t)throw new Error("Unable to find players: div:has(> .players)");if(!e)throw new Error("Unable to find action bar: .action-bar");if(!n)throw new Error("Unable to find move number: .move-number");return{playerCards:t,actionBar:e,moveNumberContainer:n}}(),d=[],m=()=>d.forEach((t=>t()));window[c]=m,d.push((()=>delete window[c]));const h=!1,{toolbar:p,actions:u}=function(t){let e=t;const n=document.createElement("div");n.style.display="flex",n.style.gap="0.4rem",n.style.flex="0 0 auto";const r=t=>{const e=document.createElement("button");return e.textContent=t,e},o=r("Hide");n.appendChild(o);const a=r(e?"Collapse":"Expand");n.appendChild(a);const i=r("Chart");n.appendChild(i);const l=r("Stats");n.appendChild(l);const c={hide:()=>{},expand:()=>{},collapse:()=>{},chart:()=>{},stats:()=>{}};return o.addEventListener("click",(()=>c.hide())),a.addEventListener("click",(()=>{e?(c.collapse(),a.textContent="Expand"):(c.expand(),a.textContent="Collapse"),e=!e})),i.addEventListener("click",(()=>c.chart())),l.addEventListener("click",(()=>c.stats())),{toolbar:n,actions:c}}(h),{setContent:b,widget:f,tearDownWidget:g}=function(t){const e=document.createElement("div");e.classList.add("mt-widget"),e.style.display="flex",e.style.flexDirection="column",e.style.paddingBlock="1rem",e.style.gap="0.5rem",e.style.boxSizing="border-box",e.style.flex="1 0 12rem";const n=document.createElement("div");n.style.flex="1 1 100%";let r=null;return e.appendChild(t),e.appendChild(n),{setContent:t=>{r&&r(),"string"==typeof t?(n.replaceChildren(t),r=null):r=t(n)},widget:e,tearDownWidget(){r&&r(),r=null,e.remove()}}}(p);d.push(g);const v=()=>o(f,"before",i),w=()=>o(f,"after",a);u.collapse=w,u.expand=v,u.hide=m,h||w(),b("Loading..."),function(t){return fetch(function(t){return`https://online-go.com/api/v1/games/${t}`}(t)).then((t=>t.json()))}(n).then((n=>{const o=function(e){const n="black"===e.gamedata.initial_player,r=n?"black":"white",o=n?"white":"black",a=null!==t(e),i={black:a?1e3*t(e):1/0,white:a?1e3*t(e):1/0};return e.gamedata.moves.map(((t,e)=>{const n=e+1,a=n%2==1?r:o,l=t[2],c={move:n,color:a,millis:l,clockPhase:i[a]>0?"main":"overtime"};return n>1&&(i[a]-=l),c}))}(n);o.length>0?(u.chart=()=>{b((t=>{const{chart:a,markCurrentBar:i}=function(t,e){const n=document.createElement("div");n.classList.add("mt-chart");const o="1rem",a=document.createElement("style");a.textContent=`\n.mt-chart, .mt-chart * {\n  box-sizing: border-box;\n}\n\n.mt-chart {\n  display: flex;\n  position: relative;\n  background-color: darkgray;\n  min-height: 100%;\n  cursor: crosshair;\n  padding-inline: ${o};\n\n  --mt-dark-highlight: #ffd800;\n  --mt-light-highlight: yellow;\n}\n\n.mt-bar {\n  flex: 1 1 100%;\n  background-color: var(--mt-bar-color);\n}\n\n.mt-bar-wrapper {\n  min-height: 100%;\n  position: relative;\n  display: flex;\n  align-items: flex-end;\n  flex: 1 0 1px;\n}\n\n.mt-bar-wrapper:hover {\n  background-color: var(--mt-light-highlight);\n}\n\n.mt-bar-wrapper:hover .mt-bar {\n  background-color: var(--mt-dark-highlight);\n}\n\n.mt-bar-wrapper::before {\n  display: none;\n  position: absolute;\n  content: attr(data-time) ' on move ' attr(data-move);\n  top: 0px;\n  min-width: 10rem;\n  padding: 0.2rem;\n  background-color: white;\n  border-radius: 5px;\n  z-index: 1;\n  text-align: center;\n  pointer-events: none;\n}\n\n.mt-bar-wrapper:hover::before {\n  display: inline;\n}\n\n.mt-bar-wrapper--left::before {\n  left: 100%;\n  border-top-left-radius: 0;\n  border-bottom-left-radius: 0;\n}\n\n.mt-bar-wrapper--right::before {\n  right: 100%;\n  border-top-right-radius: 0;\n  border-bottom-right-radius: 0;\n}\n\n/* Only when there's no hovered bar, show current bar and its tooltip */\n.mt-chart:not(:has(.mt-bar-wrapper:hover)) {\n  & .mt-bar-wrapper--current {\n    background-color: var(--mt-light-highlight);\n  }\n\n  & .mt-bar-wrapper--current .mt-bar {\n    background-color: var(--mt-dark-highlight);\n  }\n\n  & .mt-bar-wrapper--current::before {\n    display: inline;\n  }\n}\n\n.mt-yaxis-tick {\n  border-top: 1px dashed lightgray;\n  left: ${o};\n  right: ${o};\n  height: 0;\n  position: absolute;\n  z-index: 0;\n}`,n.appendChild(a);const i=Math.max(...t.map((t=>t.millis))),l=1.1*i;for(const t of function(t,e){const n=[];let r=e;for(;r<t;)n.push(r),r+=e;return n}(i,1e3*e.yTickSeconds)){const e=document.createElement("div");e.classList.add("mt-yaxis-tick"),e.style.bottom=String(t/l*100)+"%",n.appendChild(e)}return t.forEach((e=>{const o=document.createElement("div");o.classList.add("mt-bar"),o.style.height=e.millis/l*100+"%",o.style.setProperty("--mt-bar-color","black"===e.color?"black":"white");const a=document.createElement("div");a.classList.add("mt-bar-wrapper","mt-bar-wrapper--"+(e.move/t.length<.5?"left":"right")),a.dataset.time=r(e.millis),a.dataset.move=e.move,a.appendChild(o),n.appendChild(a)})),{chart:n,markCurrentBar(t){const e="mt-bar-wrapper--current",r=n.querySelector("."+e);r&&r.classList.remove(e);const o=n.querySelector(`.mt-bar-wrapper[data-move="${t}"]`);o&&o.classList.add(e)}}}(o,{yTickSeconds:e(n)||30});return t.replaceChildren(a),function(t,e){const n=t=>{const n=t.split("").filter((t=>t.match(/\d/))).join("");n&&e(Number(n))};n(t.textContent);const r=new MutationObserver((t=>{t.filter((t=>"characterData"===t.type)).forEach((t=>n(t.target.data)))}));return r.observe(t,{characterData:!0,subtree:!0}),()=>r.disconnect()}(s,(t=>i(t)))}))},u.stats=()=>{b((t=>{const{stats:e}=function(t){const e=document.createElement("div");return e.innerHTML=`\n<table class="mt-stats">\n  <caption>Time per move (median)</caption>\n  <thead>\n    <tr><th>Player</th><th>Main time</th><th>Overtime</th></tr>\n  </thead>\n  <tbody>\n  ${l(t,"black")}\n  ${l(t,"white")}\n  </tbody>\n</table>\n<style>\n.mt-stats {\n  border-collapse: collapse;\n  border: 1px solid #ddd;\n  width: 100%;\n\n  th, td {\n    padding-block: 0.3rem;\n    padding-inline: 0.8rem;\n    text-align: left;\n  }\n\n  tr:nth-child(even) {\n    background-color: #f2f2f2;\n  }\n\n  thead th {\n    background-color: #e0e0e0;\n    font-weight: bold;\n  }\n}\n</style>\n`,{stats:e}}(o);t.replaceChildren(e)}))},u.chart()):b("No moves received from server")})).catch((t=>console.error(t)))}catch(t){console.error(t),alert("Error: "+t.message)}
