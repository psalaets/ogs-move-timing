const { rollup } = require('rollup');
const resolve = require('@rollup/plugin-node-resolve').default;
const terser = require('@rollup/plugin-terser').default;
const path = require('node:path');

/**
 * @typedef {Object} Settings
 * @property {boolean} verbose
 * @property {boolean} inline
 */

module.exports.bundleCode = bundleCode;

/**
 * @param {string} entryFilePath
 * @param {Settings} settings
 * @returns {Promise<string>} code
 */
async function bundleCode(entryFilePath, settings) {
  let bundle = null;

  try {
    bundle = await rollup({
      input: entryFilePath,
      plugins: [resolve()]
    });

    const code = await generateOutput(bundle, settings);

    if (settings.verbose) {
      console.log(`
${code.length} characters from ${path.basename(entryFilePath)}:

${code}
`);
    }

    return code;
  } finally {
    if (bundle) {
      await bundle.close();
    }
  }
}

async function generateOutput(bundle, settings) {
  const { output } = await bundle.generate({
    format: settings.inline ? 'iife' : 'es',
    plugins: [
      terser({
        module: true,
        ecma: '2022',
        compress: {
          negate_iife: false,
        }
      })
    ]
  });

  for (const chunkOrAsset of output) {
    if (chunkOrAsset.type === 'chunk') {
      return chunkOrAsset.code;
    }
  }

  console.error('No chunks generated by rollup', output);
  throw new Error('No chunks generated by rollup');
}
