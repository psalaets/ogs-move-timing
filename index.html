<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Visualize time spent per move in an OGS game" />
  <link rel="stylesheet" href="https://unpkg.com/awsm.css/dist/awsm_theme_white.min.css" media="(prefers-color-scheme: no-preference), (prefers-color-scheme: light)">
  <link rel="stylesheet" href="https://unpkg.com/awsm.css/dist/awsm_theme_black.min.css" media="(prefers-color-scheme: dark)">
  <title>ogs-move-timing Bookmarklet</title>
</head>
<body>
  <main>
    <h1>ogs-move-timing</h1>
<p>Visualize time spent per move in an OGS game</p>
<h2>Installation</h2>
<p>Drag this link to your browser's bookmarks bar: &lt;a href=&quot;javascript:void (function () {
'use strict';</p>
<p>/**</p>
<ul>
<li>@typedef {number} MoveCol Zero-based index of the column, starting from the left</li>
<li>@typedef {number} MoveRow Zero-based index of the row, starting from the top</li>
<li>@typedef {number} MoveMillis Milliseconds elapsed between previous move and this move</li>
<li>@typedef {[MoveCol, MoveRow, MoveMillis]} Move A stone played on the board</li>
<li></li>
<li>@typedef {'white' | 'black'} PlayerColor</li>
<li></li>
<li>@typedef {Object} Gamedata</li>
<li>@property {Array&lt;Move&gt;} moves</li>
<li>@property {PlayerColor} initial_player</li>
<li></li>
<li></li>
<li>@typedef {Object} Game Just the game data needed for this bookmarklet, not exhaustive.</li>
<li>@property {Gamedata} gamedata</li>
<li></li>
<li>@typedef {Object} MoveTime</li>
<li>@property {number} move</li>
<li>@property {number} millis</li>
<li>@property {PlayerColor} color
*/</li>
</ul>
<p>/**</p>
<ul>
<li>@typedef {object} Landmarks</li>
<li>@property {HTMLElement} playerCards</li>
<li>@property {HTMLElement} actionBar</li>
<li>@property {HTMLElement} moveNumberContainer</li>
<li></li>
<li>@returns {Landmarks}
*/
function ogsLandmarks() {
const playerCards = document.querySelector('div:has(&gt; .players)');
const actionBar = document.querySelector('.action-bar');
const moveNumberContainer = document.querySelector('.move-number');</li>
</ul>
<p>if (!playerCards) throw new Error('Unable to find players: div:has(&gt; .players)')
if (!actionBar) throw new Error('Unable to find action bar: .action-bar');
if (!moveNumberContainer) throw new Error('Unable to find move number: .move-number');</p>
<p>return {
playerCards,
actionBar,
moveNumberContainer,
};
}</p>
<p>/**</p>
<ul>
<li>Figure out game id from a url.</li>
<li></li>
<li>@returns {string}
*/
function determineGameId(url) {
const pattern = /https:\/\/online-go\.com\/game\/(\d+)/;
const matchResult = pattern.exec(url);
// Game id is in 1st capture group
const gameId = matchResult ? matchResult[1] : null;</li>
</ul>
<p>if (!gameId) {
throw new Error('The move timing chart can only be loaded from OGS games.\n\nIf you\'re in a review, load the chart in game view first then return to the review.');
}</p>
<p>return gameId;
}</p>
<p>/**</p>
<ul>
<li>Game url in OGS API.</li>
<li></li>
<li>@param {string} gameId</li>
<li>@returns {string}
*/
function gameUrl(gameId) {
return <code>https://online-go.com/api/v1/games/${gameId}</code>;
}</li>
</ul>
<p>/**</p>
<ul>
<li>@param {string} gameId</li>
<li>@returns {Promise&lt;Game&gt;}
*/
function getGame(gameId) {
return fetch(gameUrl(gameId))
.then(resp =&gt; resp.json());
}</li>
</ul>
<p>/**</p>
<ul>
<li>@param {Game} game</li>
<li>@returns {Array&lt;MoveTime&gt;}
*/
function extractMoveTimes(game) {
const blackPlayedFirst = game.gamedata.initial_player === 'black';
const oddTurnColor = blackPlayedFirst ? 'black' : 'white';
const evenTurnColor = blackPlayedFirst ? 'white' : 'black';
const isOdd = (n) =&gt; n % 2 === 1;</li>
</ul>
<p>return game.gamedata.moves.map((move, index) =&gt; {
const moveNumber = index + 1;</p>
<p>/** @type {MoveTime} */
const moveTime = {
move: moveNumber,
color: isOdd(moveNumber) ? oddTurnColor : evenTurnColor,
millis: move[2]
};
return moveTime;
});
}</p>
<p>/**</p>
<ul>
<li>@param {Array&lt;import('../ogs.js').MoveTime&gt;} moveTimes
*/
function createChart(moveTimes) {
const chart = document.createElement('div');
chart.classList.add('mt-chart');</li>
</ul>
<p>const chartPadding = '1rem';
const style = document.createElement('style');
style.textContent = `
.mt-chart, .mt-chart * {
box-sizing: border-box;
}</p>
<p>.mt-chart {
display: flex;
position: relative;
background-color: darkgray;
min-height: 100%;
cursor: crosshair;
padding-inline: ${chartPadding};</p>
<p>--mt-dark-highlight: #ffd800;
--mt-light-highlight: yellow;
}</p>
<p>.mt-bar {
flex: 1 1 100%;
background-color: var(--mt-bar-color);
}</p>
<p>.mt-bar-wrapper {
min-height: 100%;
position: relative;
display: flex;
align-items: flex-end;
flex: 1 0 1px;
}</p>
<p>.mt-bar-wrapper:hover {
background-color: var(--mt-light-highlight);
}</p>
<p>.mt-bar-wrapper:hover .mt-bar {
background-color: var(--mt-dark-highlight);
}</p>
<p>.mt-bar-wrapper::before {
display: none;
position: absolute;
content: attr(data-time) ' on move ' attr(data-move);
top: 0px;
min-width: 10rem;
padding: 0.2rem;
background-color: white;
border-radius: 5px;
z-index: 1;
text-align: center;
pointer-events: none;
}</p>
<p>.mt-bar-wrapper:hover::before {
display: inline;
}</p>
<p>.mt-bar-wrapper--left::before {
left: 100%;
border-top-left-radius: 0;
border-bottom-left-radius: 0;
}</p>
<p>.mt-bar-wrapper--right::before {
right: 100%;
border-top-right-radius: 0;
border-bottom-right-radius: 0;
}</p>
<p>/* Only when there's no hovered bar, show current bar and its tooltip */
.mt-chart:not(:has(.mt-bar-wrapper:hover)) {
&amp; .mt-bar-wrapper--current {
background-color: var(--mt-light-highlight);
}</p>
<p>&amp; .mt-bar-wrapper--current .mt-bar {
background-color: var(--mt-dark-highlight);
}</p>
<p>&amp; .mt-bar-wrapper--current::before {
display: inline;
}
}</p>
<p>.mt-yaxis-tick {
border-top: 1px dashed lightgray;
left: ${chartPadding};
right: ${chartPadding};
height: 0;
position: absolute;
z-index: 0;
}`;
chart.appendChild(style);</p>
<p>const maxMillis = Math.max(...moveTimes.map(mt =&gt; mt.millis));
const maxY = maxMillis * 1.1; // chart y axis limit is 10% more than max value</p>
<p>// y axis ticks
for (const tickMillis of ticks(maxMillis, 30 * 1000)) {
const tick = document.createElement('div');
tick.classList.add('mt-yaxis-tick');
tick.style.bottom = String(tickMillis / maxY * 100) + '%';
chart.appendChild(tick);
}</p>
<p>// vertical bars
moveTimes.forEach(mt =&gt; {
const bar = document.createElement('div');
bar.classList.add('mt-bar');
bar.style.height = (mt.millis / maxY * 100) + '%';
bar.style.setProperty('--mt-bar-color', mt.color === 'black' ? 'black' : 'white');</p>
<p>// full height wrapper around the bar
const barWrapper = document.createElement('div');
barWrapper.classList.add('mt-bar-wrapper', 'mt-bar-wrapper--' + (mt.move / moveTimes.length &lt; 0.5 ? 'left' : 'right'));
barWrapper.dataset.time = displayTime(mt.millis);
barWrapper.dataset.move = mt.move;
barWrapper.appendChild(bar);</p>
<p>chart.appendChild(barWrapper);
});</p>
<p>return {
chart,
/**
* @paam {number} moveNumber
*/
markCurrentBar(moveNumber) {
const clazz = 'mt-bar-wrapper--current';</p>
<p>// unmark old current
const oldCurrentBar = chart.querySelector('.' + clazz);
if (oldCurrentBar) {
oldCurrentBar.classList.remove(clazz);
}</p>
<p>// mark new current
const newCurrent = chart.querySelector(<code>.mt-bar-wrapper[data-move=&amp;quot;${moveNumber}&amp;quot;]</code>);
if (newCurrent) {
newCurrent.classList.add(clazz);
}
}
};
}</p>
<p>function ticks(maxValue, interval) {
const t = [];</p>
<p>let current = interval;
while (current &lt; maxValue) {
t.push(current);
current += interval;
}</p>
<p>return t;
}</p>
<p>/**</p>
<ul>
<li>@param {number} millis</li>
<li>@returns {string}
*/
function displayTime(millis) {
const seconds = millis / 1000;
const approxSeconds = millis &gt;= 1000 ? Math.round(seconds) : seconds;
return approxSeconds &lt; 60 ? displaySeconds(approxSeconds) : displayMinutesAndSeconds(approxSeconds);
}</li>
</ul>
<p>/**</p>
<ul>
<li>@param {number} seconds</li>
<li>@retrns {string}
*/
function displaySeconds(seconds) {
const truncated = seconds.toFixed(1);
const formatted = truncated.endsWith('.0') ? truncated.slice(0, -2) : truncated;
return formatted + 's';
}</li>
</ul>
<p>/**</p>
<ul>
<li>@param {number} seconds</li>
<li>@retrns {string}
*/
function displayMinutesAndSeconds(seconds) {
const leftoverSeconds = Math.trunc(seconds % 60);</li>
</ul>
<p>return [
// whole minutes
Math.trunc(seconds / 60) + 'm',
// seconds of the partial minute, if any
leftoverSeconds !== 0 ? leftoverSeconds + 's' : ''
]
.filter(p =&gt; p)
.join(' ');
}</p>
<p>const className = 'mt-widget';</p>
<p>function alreadyExists() {
return document.getElementsByClassName(className).length &gt; 0;
}</p>
<p>/**</p>
<ul>
<li>@param {HTMLElement} toolbar
*/
function createWidget(toolbar) {
const widget = document.createElement('div');
widget.classList.add(className);
widget.style.display = 'flex';
widget.style.flexDirection = 'column';
widget.style.paddingBlock = '1rem';
widget.style.gap = '0.5rem';
widget.style.boxSizing = 'border-box';
widget.style.flex = '1 0 12rem';</li>
</ul>
<p>const content = document.createElement('div');
content.style.flex = '1 1 100%';</p>
<p>widget.appendChild(toolbar);
widget.appendChild(content);</p>
<p>return {
widget,
content,
tearDownWidget() {
widget.remove();
}
};
}</p>
<p>/**</p>
<ul>
<li>@typedef {object} ToolbarActions</li>
<li>@property {() =&gt; void} onHide</li>
<li>@property {() =&gt; void} onExpand</li>
<li>@property {() =&gt; void} onCollapse</li>
<li></li>
<li>@param {boolean} initialExpanded
*/
function createToolbar(initialExpanded) {
let expanded = initialExpanded;</li>
</ul>
<p>const toolbar = document.createElement('div');
toolbar.style.display = 'flex';
toolbar.style.gap = '0.4rem';
toolbar.style.flex = '0 0 auto';</p>
<p>const button = (id, label) =&gt; {
const b = document.createElement('button');
b.id = id;
b.textContent = label;
return b;
};</p>
<p>const hideButton = button('mt-hide', 'Hide');
toolbar.appendChild(hideButton);</p>
<p>const toggleButton = button('mt-toggle', expanded ? 'Collapse' : 'Expand');
toolbar.appendChild(toggleButton);</p>
<p>return {
toolbar,
/**
* @param {ToolbarActions} actions
*/
setToolbarActions(actions) {
hideButton.addEventListener('click', actions.onHide);
toggleButton.addEventListener('click', () =&gt; {
if (expanded) {
actions.onCollapse();
toggleButton.textContent = 'Expand';
} else {
actions.onExpand();
toggleButton.textContent = 'Collapse';
}
expanded = !expanded;
});
}
};
}</p>
<p>/**</p>
<ul>
<li>Slightly nicer wrapper around dom's element insertion methods.</li>
<li></li>
<li>@param {HTMLElement} element</li>
<li>@param {'before' | 'after'} where</li>
<li>@param {HTMLElement} referenceElement
*/
function putElement(element, where, referenceElement) {
element.remove();</li>
</ul>
<p>const insertPosition = where === 'before' ? 'beforebegin' : 'afterend';
referenceElement.insertAdjacentElement(insertPosition, element);
}</p>
<p>/**</p>
<ul>
<li>@param {HTMLElement} moveNumberContainer</li>
<li>@param {(number) =&gt; void} onChange
*/
function trackCurrentMove(moveNumberContainer, onChange) {
// Due to i18n not sure what the exact text will be so just grab digits and
// that's probably the move number.
const notify = (str) =&gt; {
const digits = str.split('').filter(ch =&gt; ch.match(/\d/)).join('');
if (digits) {
onChange(Number(digits));
}
};</li>
</ul>
<p>// invoke for current move number
notify(moveNumberContainer.textContent);</p>
<p>// watch for future move number changes
const observer = new MutationObserver((mutations) =&gt; {
mutations
.filter(m =&gt; m.type === 'characterData')
.forEach(mutation =&gt; notify(mutation.target.data));
});</p>
<p>observer.observe(moveNumberContainer, {
characterData: true,
subtree: true
});</p>
<p>return () =&gt; observer.disconnect();
}</p>
<p>if (!alreadyExists()) {
try {
const gameId = determineGameId(window.location.toString());
const { playerCards, actionBar, moveNumberContainer } = ogsLandmarks();</p>
<p>/**
* Functions to run when shutting down bookmarklet
*
* @type {Array&lt;() =&gt; void&gt;}
*/
const tearDowns = [];
const cleanUp = () =&gt; tearDowns.forEach(fn =&gt; fn());</p>
<p>// Create toolbar and widget
const initialExpanded = false;
const { toolbar, setToolbarActions } = createToolbar(initialExpanded);
const { content, widget, tearDownWidget } = createWidget(toolbar);
tearDowns.push(tearDownWidget);</p>
<p>const showBig = () =&gt; putElement(widget, 'before', actionBar);
const showSmall = () =&gt; putElement(widget, 'after', playerCards);
setToolbarActions({
onHide: cleanUp,
onExpand: showBig,
onCollapse: showSmall,
});</p>
<p>// Render widget
if (!initialExpanded) {
showSmall();
}</p>
<p>// Load game data
content.replaceChildren('Loading...');
getGame(gameId)
.then(game =&gt; {
// Create and render chart
const moveTimes = extractMoveTimes(game);
const { chart, markCurrentBar } = createChart(moveTimes);
content.replaceChildren(chart);</p>
<p>// Sync highlighted bar with current move
const stopTracking = trackCurrentMove(moveNumberContainer, (moveNumber) =&gt; markCurrentBar(moveNumber));
tearDowns.push(stopTracking);
})
.catch(e =&gt; console.error(e));
} catch (e) {
console.error(e);
alert('Error: ' + e.message);
}
}</p>
<p>})();
&quot;&gt;ogs-move-timing</a></p>
<h2>Usage</h2>
<ol>
<li>Open a (finished) game on <a href="https://online-go.com/">OGS</a>.</li>
<li>Click the bookmark you made during the Installation step.</li>
<li>A bar chart will appear in the right sidebar.
<ul>
<li>It displays the time spent on each move and highlights the move currently shown on the board.</li>
<li>Clicking a bar in the chart jumps to that move.</li>
<li>Hovering over the chart also does something.</li>
</ul>
</li>
<li>There is a &quot;Hide&quot; button above the chart. Click that when done.</li>
</ol>
<h2>Changelog</h2>
<p>Notable changes will be listed here.</p>
<h3>April 3, 2024</h3>
<ul>
<li>User can click a bar in the timing chart to change the board start to that move.</li>
</ul>
<h3>March 25, 2024</h3>
<ul>
<li>Timing chart now appears in sidebar by default, with &quot;Expand&quot; button to pop it out under the goban.</li>
</ul>
<h2>Source code</h2>
<p>https://github.com/psalaets/ogs-move-timing</p>

  </main>
</body>
</html>
